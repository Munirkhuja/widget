## Порядок настройки новой собственной интеграции

- создать базу данных для интеграции
- создать сервер для бэка
- зайти в консоли в папку для бэка (локальный тестовый или по ssh на боевой)
- склонировать с гита шаблон: "git clone https://github.com/otshelmynik/amo-public-template.git ."
- скопировать файл .env.example и назвать его .env   
- в новом файле .env настроить подключение к базе данных
- запустить миграцию (для создания папки clients): php artisan migrate
- запустить подгрузки библиотек: composer update 
- создаем новую собственную интеграцию в кабинете амо
    - Код виджета: sls_что-то-там
    - Ссылка для перенаправления: https://адрес_боевого_бэка/api/amo-auth
    - Ссылка для хука об отключении: https://integrations.salesup.pro/api/uninstall
    - Предоставить доступ: Выбрать все
    - Выбрать категорию: зависит от функционала интеграции
    - Выбрать язык: по умолчанию русский
    - Сохранить
- открываем созданную интеграцию и жмем кнопку Ключи (справа вверху)
- копируем секретный ключ, вставляем в client_secret в файле \config\amo.php
- копируем ID интеграции и вставляем в client_id в файле \config\amo.php
- в базе данных DmitryP_core в таблицу integrations добавляем новую запись
    - name: название интеграции
    - pay: 1 или 0 (1 = платная, 0 = бесплатная)
    - client_id: ID интеграции который вставляли в \config\amo.php
    - client_secret: секретный ключ который вставляли в \config\amo.php
    - amo_entity_id: Это ID товара-виджета в интеграторе, который к сделке добавляется, я в разметке находил
    - redirect_uri: Ссылка для перенаправления которую вставляли при создании интеграции (см выше): https://адрес_бэка/api/amo-auth

## Разработка бэка
Запрос для установки интеграции уже есть: https://адрес_боевого_бэка/api/amo-auth - полный путь

Есть два способа авторизации аякс запросов виджета (определение текущего клиента):
- запросы апи "/api/*" (файл описания роутов routes/api.php, все что через посредник CheckAmoAuthTokenApi) через X-Auth-Token (в script.js такие запросы делаются через self.$authorizedAjax({...}))
- запросы по токену (файл описания роутов routes/api.php, все что через посредник CheckAmoAuthToken), в script.js есть пример получения токена и использования

Когда текущий клиент определен его можно получить так: Client::current()

В классе Amo есть статические методы для общения с амо-апи, если чег-ото не хватает можно добавлять свои

Для обработки хуков есть примеры (смотреть роуты и контроллеры)

## Разработка виджета
В папке resources/widget лежат файлы заготовки для виджета

Для создания архива запустить батник widget.bat (просто для удобства)

